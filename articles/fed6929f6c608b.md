---
title: "マルチモニターから学ぶX11のscreenとdisplay"
emoji: "🖥️"
type: "tech"
topics: ["X11", "Linux", "WindowManager"]
published: false
canonical: "https://d-matsui.github.io/posts/x11-multimonitor/"
---

> この記事は[個人ブログ](https://d-matsui.github.io/posts/x11-multimonitor/)で公開した内容を再編集したものです。

## この記事について

X11 アプリケーションの開発や、X11のプロトコルに興味がある人向けに、screen, displayの概念とその歴史についてまとめた記事です。

現代のX11では、モニターが複数あっても `screen_number` は 0 を使います。screen は「物理モニター」と定義されているのに、実際には異なる扱いになっています。

この背景には、X11のマルチモニター対応の興味深い歴史があります。screen という概念は元々物理モニターを指していましたが、screen 間のウィンドウ移動ができないという問題を解決するため、Xinerama、RandR といった技術の登場とともに、その意味が変化してきました。

この記事では、マルチモニター対応の歴史を追いながら、screen と display の定義、そして現代のX11に至るまでの技術的背景を個人的にまとめます。

---

## X11の screen と display とは

X11でアプリケーションを開発していると、`screen` や `display` といった用語に出会います。これらはX11独特の意味を持ち、直感的に理解しにくい用語です。

[Xlib - C Language X Interface](https://www.x.org/releases/X11R7.6/doc/libX11/specs/libX11/libX11.html) の仕様を見ると、screen と display の定義がわかりやすく書かれています。

> A screen is a physical monitor and hardware that can be color, grayscale, or monochrome.

screen は物理的なモニターのことです。たとえば、ラップトップのモニターと外部モニターがあれば、それぞれが screen に対応します。

> A set of screens for a single user with one keyboard and one pointer (usually a mouse) is called a display.

display は、キーボードとマウス、そして screen をまとめたものです。普通「ディスプレイ」といったらモニターを想像すると思うので、X11の用語としては注意が必要です。

これらの用語は、環境変数 `$DISPLAY` にも現れます。仕様によると、`$DISPLAY` は以下の形式です。

> On POSIX-conformant systems, the display name or DISPLAY environment variable can be a string in the format: protocol/hostname:number.screen_number

形式についてまとめると、下記の通りです。

- `protocol` : プロトコルファミリー (省略可)
- `hostname` : ホスト名 (省略可)
- `number` : ディスプレイサーバー番号
- `screen_number` : スクリーン番号

たとえば、`$DISPLAY` が `:2` の場合、ローカルマシンで起動しているXディスプレイサーバー2番のデフォルトスクリーン (0) を意味します。

現代では、モニターが複数ある場合でも、デフォルトスクリーン (0) が使用されます (し、省略されます)。定義に従えばモニター毎に異なる番号になるはずですが、実際には 0 だけが使われることがほとんどです。

以下では、この理由を理解するために、X11のマルチモニター対応の歴史を見ていきます。

---

## 1 Screen = 1 モニターの時代

昔のX11では、モニターが複数ある場合、それらをそれぞれの screen として管理していました。たとえば、`:0.0` (ラップトップのモニター) と `:0.1` (外部モニター) という具合です。

この時代の大きな問題は、screen 間でウィンドウを移動できなかったことです。各 screen が独自の root window を持つため、[X11 Protocolの仕様](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html)によると、ReparentWindow リクエストで以下の制約がありました。

> A Match error is generated if: The new parent is not on the same screen as the old parent.

つまり、screen 間でウィンドウを移動することはプロトコルレベルで禁止されていました。

## Xinerama で変わった screen の扱い

この不便な状況を解決するために、[XineramaがDECから登場しました](https://en.wikipedia.org/wiki/Xinerama)。1990年代中盤〜後半のことです。

Xineramaがやったことはシンプルで、複数の物理モニターを1つの仮想スクリーンとして見せかける、というものです。たとえば、1920x1080のモニター2台を横に並べていたとして、Xサーバーは「3840x1080の1つのスクリーンがあります」とクライアントに伝えます。

これにより、クライアントからは root window が1つしかないように見え、単一のウィンドウマネージャーが screen 間をまたいでウィンドウを管理できるようになります。

ただし、Xineramaには問題がありました。設定が静的で、物理モニターを抜き差しするたびにXサーバーの設定を書きかえて再起動しないといけませんでした。

---

## RandR による動的な対応

この問題を解決したのが RandR 1.2 です。

RandR は元々、画面のリサイズと回転のために開発されました。[freedesktop.orgの記事](https://nouveau.freedesktop.org/MultiMonitorDesktop.html)によると、Version 1.2 でマルチモニター対応が追加され、Xinerama と同じように、複数のモニターを1つのスクリーンとして扱えるようになりました。

> Randr exposes the dual-head card as a single SCREEN, yet having a standard way of managing the multiple monitors.

さらに、[X11R7.3のリリースノート](https://www.x.org/archive/X11R7.3/doc/RELNOTES.txt)によると、

> Also new in the X Server since X11R7.2 is the 1.2 version of the RandR
> extension, which allows for runtime configuration of outputs within X Screens
> and an improved static configuration system for multihead in a RandR 1.2
> environment.

とあり、1.2で runtime configuration に対応したことがわかります。

---

## まとめ

この記事では、X11の screen と display、そしてマルチモニター対応の歴史を見てきました。

screen は元々物理モニターを指していましたが、Xinerama や RandR により複数モニターを含む仮想 screen へと変化しました。これにより、screen 間のウィンドウ移動が可能になり、モニターの抜き差しにも動的に対応できるようになりました。

現代の X11 で screen_number が 0 なのは、こうした歴史的経緯によるものです。

---

## 参考

- [Xlib - C Language X Interface](https://www.x.org/releases/X11R7.6/doc/libX11/specs/libX11/libX11.html)
- [X Window System Protocol](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html)
- [X11R7.3 Release Notes](https://www.x.org/archive/X11R7.3/doc/RELNOTES.txt)
- [Multi-Monitor Desktop (freedesktop.org)](https://nouveau.freedesktop.org/MultiMonitorDesktop.html)
- [Xinerama - Wikipedia](https://en.wikipedia.org/wiki/Xinerama)

---

この記事が役立ったら、LIKEやコメントで教えてください！

他の技術記事や開発記録は[私のブログ](https://d-matsui.github.io/)でも公開しています。
